// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("SECRET_DATABASE_URL")
}

model Session {
  id    String @id @default(cuid())
  token String @unique

  created_at DateTime @default(now())

  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  user_id String
}

model User {
  id              String   @id @default(uuid())
  full_name       String
  email           String   @unique
  created_at      DateTime @default(now())
  //Password fields
  password_salt   String
  password_hash   String
  password_digest String

  //relations
  sessions Session[]
}

model Catalog {
  id           String    @id @default(cuid())
  name         String    @unique // Unieke naam voor de catalogus (bijv. 'eindhoven-open-data')
  title        String // Leesbare titel (bijv. 'Eindhoven Open Data Portal')
  description  String? // Optionele beschrijving
  logo_url     String? // Optionele link naar logo afbeelding
  api_standard String // Bijv. 'opendatasoft_explore_v2', 'ckan_api_v3', 'socrata'
  api_url      String // Volledige basis-URL van de API (bijv. https://data.eindhoven.nl/api/explore/v2.1)
  api_key      String? // Optionele API-sleutel voor authenticatie
  // Optionele velden die automatisch kunnen worden ingevuld of gebruikt voor beheer
  is_active    Boolean   @default(true) // Of de catalogus momenteel wordt gesynchroniseerd
  last_sync    DateTime? // Datum van de laatste synchronisatie
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  dataset      Dataset[]

  @@map("catalogs")
}

model Dataset {
  id String @id @default(cuid())

  // üîó Relatie met de oorspronkelijke catalogus
  catalog    Catalog @relation(fields: [catalog_id], references: [id], onDelete: Cascade)
  catalog_id String

  // üì¶ DCAT-AP 2.0 - Core Metadata (zo compleet mogelijk)
  title          String // dct:title
  description    String // dct:description
  identifier     String // dct:identifier ‚Äî uniek binnen de catalogus of globaal
  issued         DateTime? // dct:issued
  modified       DateTime? // dct:modified
  language       String? // dct:language (bijv. "nl", "en")
  theme          String? // dcat:theme ‚Äî URI of label (bijv. "http://publications.europa.eu/resource/authority/data-theme/ENER")
  spatial        String? // dct:spatial ‚Äî WKT of URI (bijv. "Eindhoven")
  temporal_start DateTime? // dcterms:temporal ‚Äî start
  temporal_end   DateTime? // dcterms:temporal ‚Äî end

  // üìÑ Licentie & toegang (DCAT-AP velden)
  license       String? // dct:license ‚Äî URI (bijv. "http://creativecommons.org/licenses/by/4.0/")
  access_rights String? // dcat:accessRights ‚Äî URI (bijv. "http://publications.europa.eu/resource/authority/access-right/PUBLIC")

  // üîó Distributie (minimaal 1)
  access_url   String? // dcat:accessURL ‚Äî API-endpoint waar data te vinden is
  download_url String? // dcat:downloadURL ‚Äî directe download (optioneel)
  media_type   String? // dcat:mediaType ‚Äî bijv. "application/json"

  // ‚öôÔ∏è Beheer binnen jouw dataspace (niet onderdeel van DCAT-AP)
  is_published  Boolean       @default(false) // Of deze dataset wordt opgenomen in jouw DCAT-AP feed
  policy_intent PolicyIntent? @default(PUBLIC) // Simulatie van toegangsbeleid (zie enum hieronder)
  notes         String? // Interne notities (bijv. "Gebruikt in Inzicht Verlicht")

  // üïí Tijdsaanduidingen
  imported_at      DateTime          @default(now()) // Wanneer metadata ge√Ømporteerd is
  published_at     DateTime? // Wanneer voor het eerst gepubliceerd in jouw feed
  ldn_notification LDNNotification[]

  @@unique([catalog_id, identifier]) // Zorg dat dezelfde dataset niet dubbel wordt ge√Ømporteerd
  @@map("datasets")
}

model LDNNotification {
  id         String  @id @default(cuid())
  // The dataset this notification is about
  dataset    Dataset @relation(fields: [dataset_id], references: [id], onDelete: Cascade)
  dataset_id String

  // LDN notification content (stored as JSON)
  content Json // The actual LDN notification payload (JSON-LD)

  // Notification metadata
  type       String? // The LDN notification type (e.g., "Update", "Create", "Delete")
  created_at DateTime @default(now())

  // Optional: Track delivery status if needed
  delivered    Boolean   @default(false)
  delivered_at DateTime?

  // Optional: Link to LDES event if you're using both
  ldes_event_id String?

  @@index([dataset_id, created_at])
}

enum PolicyIntent {
  PUBLIC // Openbaar toegankelijk (geen OPA-check nodig)
  RESTRICTED // Alleen voor bepaalde partijen (OPA regelt toegang via APISIX)
  INTERNAL // Alleen Fontys (niet publiceren via DCAT-AP)
}
